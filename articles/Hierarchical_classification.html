<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hierarchical Classification • tabnet</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Hierarchical Classification">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tabnet</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.6.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Hierarchical_classification.html">Hierarchical Classification</a>
    </li>
    <li>
      <a href="../articles/interpretation.html">Interpretation tools</a>
    </li>
    <li>
      <a href="../articles/Missing_data_predictors.html">Training a Tabnet model from missing-values dataset</a>
    </li>
    <li>
      <a href="../articles/selfsupervised_training.html">Self-supervised training and fine-tuning</a>
    </li>
    <li>
      <a href="../articles/tidymodels-interface.html">Fitting tabnet with tidymodels</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mlverse/tabnet/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Hierarchical Classification</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mlverse/tabnet/blob/main/vignettes/Hierarchical_classification.Rmd" class="external-link"><code>vignettes/Hierarchical_classification.Rmd</code></a></small>
      <div class="hidden name"><code>Hierarchical_classification.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlverse.github.io/tabnet/" class="external-link">tabnet</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/gluc/data.tree" class="external-link">data.tree</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rsample.tidymodels.org" class="external-link">rsample</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">202307</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="data-preparation">Data preparation<a class="anchor" aria-label="anchor" href="#data-preparation"></a>
</h2>
<p>The supported data format for hierarchical classification is the
<code>Node</code> object format from package
<a href="https://github.com/gluc/data.tree" class="external-link">data.tree</a>.</p>
<p>This is a general purpose format that fits generic hierarchical tree
encoding needs. Each node of the tree is associated with predictor
values through the <code>attributes</code> in the data <code>Node</code>
object.</p>
<ul>
<li>A very basic example is the <code>acme</code> dataset to show you
how the two predictors values <code>cost</code> and <code>p</code> are
associates attributes of each node in the hierarchy :</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">acme</span>, package <span class="op">=</span> <span class="st">"data.tree"</span><span class="op">)</span></span>
<span><span class="va">acme</span><span class="op">$</span><span class="va">attributesAll</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">acme</span>, <span class="st">"cost"</span>, <span class="st">"p"</span> , limit <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span></code></pre></div>
<ul>
<li><p>Multiple manual or programmatic methods are available to create
or update predictors. They are detailled in the
<code><a href="https://cran.rstudio.com/web/packages/data.tree/vignettes/data.tree.html" class="external-link">vignette("data.tree", package = "data.tree")</a></code>.</p></li>
<li><p>a lot of native hierarchical data-format conversion from files to
<code>Node</code> are covered by the<a href="https://github.com/gluc/data.tree" class="external-link">data.tree</a> package.
You can find them in the “Create tree from a file” section of the same
vignette. If needed, the <a href="https://github.com/emmanuelparadis/ape" class="external-link">ape</a> package covers a lot of
conversion format to the <code>philo</code> format. Thus you can reach
the <code>Node</code> format in maybe two transformation steps…</p></li>
<li><p>A quick way to achieve <code>Node</code> format from a data frame
with columns being the different levels of the hierarchy consist in
pasting the columns into a single string with <code>"/"</code> separator
into a <code>pathString</code> column. This will be turn into the
expected hierarchy by the <code><a href="https://rdrr.io/pkg/data.tree/man/as.Node.html" class="external-link">data.tree::as.Node()</a></code>
command.</p></li>
</ul>
<p>Let’s do it with <code>starwars</code> dataset as a toy example :</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">starwars</span>, package <span class="op">=</span> <span class="st">"dplyr"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">starwars</span>, <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># erroneous Node construction</span></span>
<span><span class="va">starwars_tree</span> <span class="op">&lt;-</span> <span class="va">starwars</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>pathString <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"StarWars_characters"</span>, <span class="va">species</span>, <span class="va">sex</span>, <span class="va">`name`</span>, sep <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/data.tree/man/as.Node.html" class="external-link">as.Node</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">starwars_tree</span>, <span class="st">"name"</span>,<span class="st">"height"</span>, <span class="st">"mass"</span>, <span class="st">"eye_color"</span>, limit <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span></code></pre></div>
<p>You may have noticed that <code>name</code> and <code>height</code>
have unexpected values according to the original data:
<code>Human</code> is not part of the <code>name</code> in orginal
dataset, and <code>height</code> values have been changed into the local
height of the tree. This is due to some rules we will have to follow to
create the Node from data frame.</p>
</div>
<div class="section level2">
<h2 id="node-preparation-rules-for-tabnet-models">
<code>Node</code> preparation rules for {tabnet} models<a class="anchor" aria-label="anchor" href="#node-preparation-rules-for-tabnet-models"></a>
</h2>
<div class="section level3">
<h3 id="avoid-factor-predictors">Avoid <code>factor</code> predictors<a class="anchor" aria-label="anchor" href="#avoid-factor-predictors"></a>
</h3>
<p>As <code><a href="https://rdrr.io/pkg/data.tree/man/as.Node.html" class="external-link">as.Node()</a></code> will only consider the as.numeric() values
of a factor(), you should turn them into characters before applying the
<code><a href="https://rdrr.io/pkg/data.tree/man/as.Node.html" class="external-link">as.Node()</a></code> function in order for {tabnet} to properly embed
them.</p>
</div>
<div class="section level3">
<h3 id="avoid-column-name-collision-with-reserved-data-tree-names">Avoid column name collision with reserved {data.tree} names<a class="anchor" aria-label="anchor" href="#avoid-column-name-collision-with-reserved-data-tree-names"></a>
</h3>
<p><code>name</code> and <code>height</code> are both part of the
<code>NODE_RESERVED_NAMES_CONST</code> reserved list of names for
<code>Node</code> attributes. So they must <strong>not be used</strong>
as predictor names, or the <code><a href="https://rdrr.io/pkg/data.tree/man/as.Node.html" class="external-link">as.Node()</a></code> function will silently
discard them.</p>
</div>
<div class="section level3">
<h3 id="avoid-column-named-level_-to-avoid-collision-with-output-data-tree-names">Avoid column named <code>level_*</code> to avoid collision with
output data.tree names<a class="anchor" aria-label="anchor" href="#avoid-column-named-level_-to-avoid-collision-with-output-data-tree-names"></a>
</h3>
<p>Your dataset hierarchy will be turn internally into multi-outcomes
named <code>level_1</code> to <code>level_n</code>, n beeing the depth
of your tree. Thus column names starting with <code>level_</code> should
be avoided.</p>
</div>
<div class="section level3">
<h3 id="ensure-the-last-hierarchy-of-the-tree-is-the-observation-id">Ensure the last hierarchy of the tree is the observation id<a class="anchor" aria-label="anchor" href="#ensure-the-last-hierarchy-of-the-tree-is-the-observation-id"></a>
</h3>
<p>The tree only keeps a single row of attributes per tree leaf. Thus in
order to transfer your complete predictors dataset into the Node object,
you must keep the last level of the hierarchy to be a unique observation
identifier (last resort beeing <code><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">rowid_to_column()</a></code> to achieve
it).</p>
<p>The classification will be done <strong>removing the last level of
hierarchy</strong> in any case.</p>
</div>
<div class="section level3">
<h3 id="ensure-there-is-a-root-level-in-the-hierarchy">Ensure there is a root level in the hierarchy<a class="anchor" aria-label="anchor" href="#ensure-there-is-a-root-level-in-the-hierarchy"></a>
</h3>
<p>The tree should have a single root for all nodes to be consistent.
Thus you have to use a constant prefix to all
<code>pathString</code>.</p>
<p>The classification will be done <strong>removing the first level of
hierarchy</strong> in any case.</p>
<p>Now let’s have all those rules applied to the
<code>starwars_tree</code> :</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># demonstration of reserved column modification in Node construction</span></span>
<span><span class="va">starwars_tree</span> <span class="op">&lt;-</span> <span class="va">starwars</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>`_name` <span class="op">=</span> <span class="st">"name"</span>, `_height` <span class="op">=</span> <span class="st">"height"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>pathString <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"StarWars_characters"</span>, <span class="va">species</span>, <span class="va">sex</span>, <span class="va">`_name`</span>, sep <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/data.tree/man/as.Node.html" class="external-link">as.Node</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">starwars_tree</span>, <span class="st">"name"</span>, <span class="st">"_name"</span>,<span class="st">"_height"</span>, <span class="st">"mass"</span>, <span class="st">"eye_color"</span>, limit <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span></code></pre></div>
<p>We can see that the reserved <code>name</code> column contains
slightly different content that the original <code>_name</code>
column.</p>
</div>
</div>
<div class="section level2">
<h2 id="model-building">Model building<a class="anchor" aria-label="anchor" href="#model-building"></a>
</h2>
<div class="section level3">
<h3 id="data-set-split">Data set split<a class="anchor" aria-label="anchor" href="#data-set-split"></a>
</h3>
<p>The <code>starwars</code> dataset contains list columns, hosting some
variability in the predictor values. Thus we decide here to
<code>unnest_longer</code> every list column to each of its values. This
will triple the size of the <code>starwars</code> dataset.<br>
The dataset split here will be done upfront of the transformation into
<code><a href="https://rdrr.io/pkg/data.tree/man/as.Node.html" class="external-link">as.Node()</a></code>. We will use
<code><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">rsample::initial_split()</a></code> to split with a stratification on
the parent category of the first level of our hierarchy which is
<code>species</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">starw_split</span> <span class="op">&lt;-</span> <span class="va">starwars</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest_longer.html" class="external-link">unnest_longer</a></span><span class="op">(</span><span class="va">films</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest_longer.html" class="external-link">unnest_longer</a></span><span class="op">(</span><span class="va">vehicles</span>, keep_empty <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest_longer.html" class="external-link">unnest_longer</a></span><span class="op">(</span><span class="va">starships</span>, keep_empty <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">initial_split</a></span><span class="op">(</span> prop <span class="op">=</span> <span class="fl">.8</span>, strata <span class="op">=</span> <span class="st">"species"</span><span class="op">)</span></span></code></pre></div>
<p>In order to train a model properly, we should prevent the outcomes to
be part of the predictor columns. For the sake of demonstration, the
<code>_name</code> column was present in <code>starwars_tree</code> but
must now be dropped.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># correct Node construction for hierarchical modeling</span></span>
<span><span class="va">starwars_train_tree</span> <span class="op">&lt;-</span> <span class="va">starw_split</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">training</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># avoid reserved column names</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>`_name` <span class="op">=</span> <span class="st">"name"</span>, `_height` <span class="op">=</span> <span class="st">"height"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">rowid_to_column</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>pathString <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"StarWars_characters"</span>, <span class="va">species</span>, <span class="va">sex</span>, <span class="va">rowid</span>, sep <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># remove outcomes labels from predictors</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">species</span>, <span class="op">-</span><span class="va">sex</span>, <span class="op">-</span><span class="va">`_name`</span>, <span class="op">-</span><span class="va">rowid</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># turn it as hierarchical Node</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/data.tree/man/as.Node.html" class="external-link">as.Node</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">starwars_test_tree</span> <span class="op">&lt;-</span> <span class="va">starw_split</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">testing</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>`_name` <span class="op">=</span> <span class="st">"name"</span>, `_height` <span class="op">=</span> <span class="st">"height"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">rowid_to_column</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>pathString <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"StarWars_characters"</span>, <span class="va">species</span>, <span class="va">sex</span>, <span class="va">rowid</span>, sep <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">species</span>, <span class="op">-</span><span class="va">sex</span>, <span class="op">-</span><span class="va">`_name`</span>, <span class="op">-</span><span class="va">rowid</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/data.tree/man/as.Node.html" class="external-link">as.Node</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">starwars_train_tree</span><span class="op">$</span><span class="va">attributesAll</span></span></code></pre></div>
<p>Now we can see that none of the predictor leaks the outcome hierarchy
information.</p>
</div>
</div>
<div class="section level2">
<h2 id="model-building-1">Model building<a class="anchor" aria-label="anchor" href="#model-building-1"></a>
</h2>
<p>This <code>starwars_tree</code> can now be used as an input for
<code><a href="../reference/tabnet_fit.html">tabnet_fit()</a></code> :</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tabnet_config.html">tabnet_config</a></span><span class="op">(</span>decision_width <span class="op">=</span> <span class="fl">8</span>, attention_width <span class="op">=</span> <span class="fl">8</span>, num_steps <span class="op">=</span> <span class="fl">3</span>, penalty <span class="op">=</span> <span class="fl">.003</span>, cat_emb_dim <span class="op">=</span> <span class="fl">2</span>, valid_split <span class="op">=</span> <span class="fl">0.2</span>, learn_rate <span class="op">=</span> <span class="fl">1e-3</span>, lr_scheduler <span class="op">=</span> <span class="st">"reduce_on_plateau"</span>, early_stopping_monitor <span class="op">=</span> <span class="st">"valid_loss"</span>, early_stopping_patience <span class="op">=</span> <span class="fl">4</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">starw_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tabnet_fit.html">tabnet_fit</a></span><span class="op">(</span><span class="va">starwars_train_tree</span>, config <span class="op">=</span> <span class="va">config</span>, epoch <span class="op">=</span> <span class="fl">170</span>, checkpoint_epochs <span class="op">=</span> <span class="fl">25</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="model-diagnostic">Model diagnostic<a class="anchor" aria-label="anchor" href="#model-diagnostic"></a>
</h2>
<p>We have avoid the verbose output of the model, thus very first
diagnostic is the check for model over-fitting though the training loss
plot.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">starw_model</span><span class="op">)</span></span></code></pre></div>
<p>Then global feature importance gives us a clue of model quality</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">vip</span><span class="fu">::</span><span class="fu"><a href="https://koalaverse.github.io/vip/reference/vip.html" class="external-link">vip</a></span><span class="op">(</span><span class="va">starw_model</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="model-inference">Model inference<a class="anchor" aria-label="anchor" href="#model-inference"></a>
</h2>
<p>We can infer on the test-set</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">starwars_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">starw_model</span>, <span class="va">starwars_test_tree</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/node_to_df.html">node_to_df</a></span><span class="op">(</span><span class="va">starwars_test_tree</span><span class="op">)</span><span class="op">$</span><span class="va">y</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">starwars_hat</span>, n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p>We can see in the Warnings that the dataset is a challenge as many
new levels are found in a lot of predictors in the test set.<br>
The model also here is very poor on the <code>level_2</code> (
<code>species</code> ) and on <code>level_3</code> ( <code>sex</code> )
as this is definitively not a model-intended dataset. The reason is that
the input dataset not collecting large samples of distinctive
observation per leaf, but rather a very diverse but limited number of
characters compatible with watching a movie saga.</p>
<p>Despite the performance, we do have local feature importance on the
complete dataset here :</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">starwars_explain</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tabnet_explain.html">tabnet_explain</a></span><span class="op">(</span><span class="va">starw_model</span>, <span class="va">starwars_test_tree</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">starwars_explain</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">starwars_explain</span>, type <span class="op">=</span> <span class="st">"steps"</span><span class="op">)</span></span></code></pre></div>
<p>Hopefully your own hierarchical outcome will have a better success
than the one here with <code>starwars</code> dataset. But in this
journey, you have learned a lot in the data format constraints and
solutions, and you now have a new performing solution in your
toolbox.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Daniel Falbel, Christophe Regouby.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

      </footer>
</div>






  </body>
</html>
